---
name: database-health-monitor
description: Monitors database health, performs automatic maintenance, cleans expired data, and generates health reports. Triggers weekly or on-demand. Integrates with existing database scripts in scripts/database/ and scripts/maintenance/. Prevents data accumulation issues.
---

# Database Health Monitor

> æ•°æ®åº“å¥åº·ç›‘æ§å™¨ - è‡ªåŠ¨ç»´æŠ¤å’Œå¥åº·æ£€æŸ¥

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

1. **å®šæœŸå¥åº·æ£€æŸ¥**
2. **è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®**
3. **æ€§èƒ½ç›‘æ§**
4. **ç”Ÿæˆç»´æŠ¤æŠ¥å‘Š**

---

## è§¦å‘æ¡ä»¶

### è‡ªåŠ¨è§¦å‘

1. **å®šæœŸè§¦å‘**
   - æ¯å‘¨ä¸€è‡ªåŠ¨è¿è¡Œ
   - æ¯æœˆ 1 å·ç”Ÿæˆæœˆåº¦æŠ¥å‘Š

2. **é˜ˆå€¼è§¦å‘**
   - æ•°æ®åº“å¤§å° > 1GB â†’ è§¦å‘æ¸…ç†
   - åŒ¹é…è®°å½• > 10000 æ¡ â†’ è§¦å‘æ¸…ç†
   - æŸ¥è¯¢å“åº”æ—¶é—´ > 1s â†’ è§¦å‘æ€§èƒ½æ£€æŸ¥

### æ‰‹åŠ¨è§¦å‘

ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è¯·æ±‚ï¼š
- "æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€"
- "æ¸…ç†è¿‡æœŸæ•°æ®"
- "ç”Ÿæˆæ•°æ®åº“æŠ¥å‘Š"

---

## æ‰§è¡Œæµç¨‹

### æ­¥éª¤ 1: å¥åº·æ£€æŸ¥

**æ£€æŸ¥é¡¹ç›®**ï¼š
```
1. æ•°æ®åº“è¿æ¥çŠ¶æ€
2. æ•°æ®åº“å¤§å°
3. è¡¨è®°å½•æ•°é‡
4. ç´¢å¼•å¥åº·çŠ¶æ€
5. æŸ¥è¯¢æ€§èƒ½
6. ç£ç›˜ç©ºé—´
```

**æ£€æŸ¥è„šæœ¬**ï¼š
```bash
# ä½¿ç”¨ç°æœ‰è„šæœ¬
node scripts/database/check_match_records.js
```

**æ£€æŸ¥ç»“æœ**ï¼š
```json
{
  "timestamp": "2026-02-15T12:00:00Z",
  "status": "healthy",
  "checks": {
    "connection": { "status": "ok", "responseTime": "50ms" },
    "databaseSize": { "status": "warning", "size": "1.2GB", "threshold": "1GB" },
    "matchRecords": { "status": "ok", "count": 8500, "threshold": 10000 },
    "queryPerformance": { "status": "ok", "avgResponseTime": "250ms" },
    "diskSpace": { "status": "ok", "available": "50GB" }
  }
}
```

---

### æ­¥éª¤ 2: è‡ªåŠ¨æ¸…ç†

**æ¸…ç†ç­–ç•¥**ï¼š
```
1. åˆ é™¤ 30 å¤©å‰çš„åŒ¹é…è®°å½•
2. åˆ é™¤å¤±è´¥çš„ä¸Šä¼ è®°å½•
3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
4. ä¼˜åŒ–æ•°æ®åº“è¡¨
```

**æ¸…ç†è„šæœ¬**ï¼š
```bash
# ä½¿ç”¨ç°æœ‰è„šæœ¬
node scripts/database/delete_old_matches.js
node scripts/maintenance/cleanup_duplicates.js
bash scripts/maintenance/clear_cache.sh
```

**æ¸…ç†ç»“æœ**ï¼š
```json
{
  "timestamp": "2026-02-15T12:00:00Z",
  "cleanupActions": [
    {
      "action": "delete_old_matches",
      "deletedRecords": 1250,
      "freedSpace": "150MB"
    },
    {
      "action": "cleanup_duplicates",
      "deletedRecords": 50,
      "freedSpace": "5MB"
    },
    {
      "action": "clear_cache",
      "freedSpace": "200MB"
    }
  ],
  "totalFreedSpace": "355MB"
}
```

---

### æ­¥éª¤ 3: æ€§èƒ½ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**ï¼š
```
1. æŸ¥è¯¢å“åº”æ—¶é—´
2. æ•°æ®åº“è¿æ¥æ•°
3. æ…¢æŸ¥è¯¢æ—¥å¿—
4. ç´¢å¼•ä½¿ç”¨ç‡
```

**æ€§èƒ½åˆ†æ**ï¼š
```typescript
interface PerformanceMetrics {
  avgQueryTime: number;
  slowQueries: Query[];
  connectionPoolUsage: number;
  indexUsage: {
    tableName: string;
    indexName: string;
    usageRate: number;
  }[];
}
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
å¦‚æœå‘ç°æ…¢æŸ¥è¯¢ â†’ å»ºè®®æ·»åŠ ç´¢å¼•
å¦‚æœè¿æ¥æ± æ»¡ â†’ å»ºè®®å¢åŠ è¿æ¥æ•°
å¦‚æœç´¢å¼•æœªä½¿ç”¨ â†’ å»ºè®®åˆ é™¤ç´¢å¼•
```

---

### æ­¥éª¤ 4: ç”ŸæˆæŠ¥å‘Š

**æŠ¥å‘Šæ ¼å¼**ï¼š
```markdown
# æ•°æ®åº“å¥åº·æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´**: 2026-02-15 12:00:00
**æ•°æ®åº“**: job-decision-system (Supabase PostgreSQL)
**æ€»ä½“çŠ¶æ€**: âœ… å¥åº· / âš ï¸ è­¦å‘Š / âŒ å¼‚å¸¸

---

## ğŸ“Š å¥åº·æ£€æŸ¥ç»“æœ

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| æ•°æ®åº“è¿æ¥ | âœ… | å“åº”æ—¶é—´ 50ms |
| æ•°æ®åº“å¤§å° | âš ï¸ | 1.2GB (è¶…è¿‡é˜ˆå€¼ 1GB) |
| åŒ¹é…è®°å½•æ•° | âœ… | 8,500 æ¡ |
| æŸ¥è¯¢æ€§èƒ½ | âœ… | å¹³å‡å“åº” 250ms |
| ç£ç›˜ç©ºé—´ | âœ… | å¯ç”¨ 50GB |

---

## ğŸ§¹ æ¸…ç†æ“ä½œ

### å·²æ‰§è¡Œçš„æ¸…ç†
1. **åˆ é™¤è¿‡æœŸåŒ¹é…è®°å½•**
   - åˆ é™¤è®°å½•: 1,250 æ¡
   - é‡Šæ”¾ç©ºé—´: 150MB
   - æ¸…ç†èŒƒå›´: 30 å¤©å‰çš„æ•°æ®

2. **æ¸…ç†é‡å¤è®°å½•**
   - åˆ é™¤è®°å½•: 50 æ¡
   - é‡Šæ”¾ç©ºé—´: 5MB

3. **æ¸…ç†ç¼“å­˜**
   - é‡Šæ”¾ç©ºé—´: 200MB

**æ€»è®¡é‡Šæ”¾ç©ºé—´**: 355MB

---

## ğŸ“ˆ æ€§èƒ½åˆ†æ

### æŸ¥è¯¢æ€§èƒ½
- å¹³å‡æŸ¥è¯¢æ—¶é—´: 250ms
- æœ€æ…¢æŸ¥è¯¢: 850ms (åŒ¹é…ç®—æ³•æŸ¥è¯¢)
- æ…¢æŸ¥è¯¢æ•°é‡: 3

### æ…¢æŸ¥è¯¢è¯¦æƒ…
1. **åŒ¹é…ç®—æ³•æŸ¥è¯¢** (850ms)
   ```sql
   SELECT * FROM match_results WHERE created_at > ...
   ```
   **å»ºè®®**: åœ¨ created_at å­—æ®µæ·»åŠ ç´¢å¼•

2. **ç®€å†æœç´¢æŸ¥è¯¢** (650ms)
   ```sql
   SELECT * FROM resumes WHERE skills LIKE '%React%'
   ```
   **å»ºè®®**: ä½¿ç”¨å…¨æ–‡æœç´¢ç´¢å¼•

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

| è¡¨å | è®°å½•æ•° | å¤§å° | å¢é•¿ç‡ |
|------|--------|------|--------|
| match_results | 8,500 | 800MB | +5%/å‘¨ |
| resumes | 1,200 | 300MB | +2%/å‘¨ |
| job_descriptions | 500 | 100MB | +1%/å‘¨ |

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### ç«‹å³å¤„ç† (P0)
1. æ•°æ®åº“å¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œå»ºè®®å¢åŠ æ¸…ç†é¢‘ç‡
2. ä¸º match_results.created_at æ·»åŠ ç´¢å¼•

### åç»­ä¼˜åŒ– (P1)
1. è€ƒè™‘å½’æ¡£ 90 å¤©å‰çš„æ•°æ®
2. ä¼˜åŒ–åŒ¹é…ç®—æ³•æŸ¥è¯¢
3. å®æ–½å…¨æ–‡æœç´¢ç´¢å¼•

---

## ğŸ“… ä¸‹æ¬¡ç»´æŠ¤

**å»ºè®®æ—¶é—´**: 2026-02-22 (ä¸‹å‘¨ä¸€)
**é¢„è®¡æ“ä½œ**:
- æ¸…ç†è¿‡æœŸæ•°æ®
- æ€§èƒ½æ£€æŸ¥
- ç´¢å¼•ä¼˜åŒ–

---

## ğŸ“ ç›¸å…³è„šæœ¬

- æ£€æŸ¥è„šæœ¬: [check_match_records.js](../../../scripts/database/check_match_records.js)
- æ¸…ç†è„šæœ¬: [delete_old_matches.js](../../../scripts/database/delete_old_matches.js)
- ç»´æŠ¤è„šæœ¬: [cleanup_duplicates.js](../../../scripts/maintenance/cleanup_duplicates.js)
```

---

## ç»´æŠ¤è„šæœ¬é›†æˆ

### ç°æœ‰è„šæœ¬

**æ•°æ®åº“è„šæœ¬** (`scripts/database/`):
```
- check_match_records.js      # æ£€æŸ¥åŒ¹é…è®°å½•
- delete_old_matches.js        # åˆ é™¤è¿‡æœŸè®°å½•
```

**ç»´æŠ¤è„šæœ¬** (`scripts/maintenance/`):
```
- cleanup_duplicates.js        # æ¸…ç†é‡å¤è®°å½•
- clear_cache.sh               # æ¸…ç†ç¼“å­˜
```

### é›†æˆæ–¹å¼

**ç»Ÿä¸€è°ƒç”¨æ¥å£**ï¼š
```typescript
interface MaintenanceScript {
  name: string;
  path: string;
  execute(): Promise<MaintenanceResult>;
}

const scripts: MaintenanceScript[] = [
  {
    name: "check_match_records",
    path: "scripts/database/check_match_records.js",
    execute: async () => {
      const result = await runScript("node", [this.path]);
      return parseResult(result);
    }
  },
  // ... æ›´å¤šè„šæœ¬
];
```

---

## è‡ªåŠ¨åŒ–ç»´æŠ¤è®¡åˆ’

### æ¯æ—¥ç»´æŠ¤ (è‡ªåŠ¨)
```
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- ç›‘æ§æŸ¥è¯¢æ€§èƒ½
- è®°å½•æ€§èƒ½æŒ‡æ ‡
```

### æ¯å‘¨ç»´æŠ¤ (è‡ªåŠ¨)
```
- å®Œæ•´å¥åº·æ£€æŸ¥
- æ¸…ç† 30 å¤©å‰çš„æ•°æ®
- ç”Ÿæˆå‘¨æŠ¥å‘Š
- æ€§èƒ½ä¼˜åŒ–å»ºè®®
```

### æ¯æœˆç»´æŠ¤ (è‡ªåŠ¨)
```
- æ·±åº¦å¥åº·æ£€æŸ¥
- å½’æ¡£ 90 å¤©å‰çš„æ•°æ®
- ç”Ÿæˆæœˆåº¦æŠ¥å‘Š
- å®¹é‡è§„åˆ’å»ºè®®
```

---

## å‘Šè­¦æœºåˆ¶

### å‘Šè­¦çº§åˆ«

**P0 (ç´§æ€¥)**:
- æ•°æ®åº“è¿æ¥å¤±è´¥
- ç£ç›˜ç©ºé—´ < 10%
- æŸ¥è¯¢å“åº”æ—¶é—´ > 5s

**P1 (è­¦å‘Š)**:
- æ•°æ®åº“å¤§å° > é˜ˆå€¼
- è®°å½•æ•° > é˜ˆå€¼
- æ…¢æŸ¥è¯¢æ•°é‡ > 10

**P2 (æç¤º)**:
- å»ºè®®æ¸…ç†æ•°æ®
- å»ºè®®ä¼˜åŒ–ç´¢å¼•

### å‘Šè­¦æ–¹å¼

```
æ£€æµ‹åˆ°å‘Šè­¦
  â†“
ç”Ÿæˆå‘Šè­¦æŠ¥å‘Š
  â†“
ä¿å­˜åˆ° docs/05-é—®é¢˜æ’æŸ¥/æ•°æ®åº“å‘Šè­¦-YYYY-MM-DD.md
  â†“
é€šçŸ¥ç”¨æˆ·
```

---

## æ•°æ®å½’æ¡£ç­–ç•¥

### å½’æ¡£è§„åˆ™

**åŒ¹é…è®°å½•**:
```
- ä¿ç•™ 30 å¤©å†…çš„æ•°æ®ï¼ˆçƒ­æ•°æ®ï¼‰
- å½’æ¡£ 30-90 å¤©çš„æ•°æ®ï¼ˆæ¸©æ•°æ®ï¼‰
- åˆ é™¤ 90 å¤©å‰çš„æ•°æ®ï¼ˆå†·æ•°æ®ï¼‰
```

**ç®€å†æ•°æ®**:
```
- ä¿ç•™æ‰€æœ‰ç®€å†ï¼ˆä¸åˆ é™¤ï¼‰
- å½’æ¡£ 180 å¤©æœªä½¿ç”¨çš„ç®€å†
```

**JD æ•°æ®**:
```
- ä¿ç•™æ‰€æœ‰ JDï¼ˆä¸åˆ é™¤ï¼‰
- å½’æ¡£ 180 å¤©æœªä½¿ç”¨çš„ JD
```

### å½’æ¡£å®ç°

```typescript
interface ArchiveStrategy {
  tableName: string;
  retentionDays: number;
  archiveTable: string;
  
  async archive() {
    // 1. å¤åˆ¶æ•°æ®åˆ°å½’æ¡£è¡¨
    await copyToArchive();
    
    // 2. åˆ é™¤åŸè¡¨æ•°æ®
    await deleteFromSource();
    
    // 3. è®°å½•å½’æ¡£æ—¥å¿—
    await logArchive();
  }
}
```

---

## å®¹é‡è§„åˆ’

### å¢é•¿é¢„æµ‹

**åŸºäºå†å²æ•°æ®é¢„æµ‹**ï¼š
```
å½“å‰æ•°æ®é‡: 1.2GB
æ¯å‘¨å¢é•¿: 60MB
é¢„è®¡ 6 ä¸ªæœˆå: 2.6GB
é¢„è®¡ 1 å¹´å: 4.3GB
```

**å®¹é‡å»ºè®®**ï¼š
```
å¦‚æœå¢é•¿ç‡ > 10%/æœˆ â†’ å»ºè®®å¢åŠ å­˜å‚¨
å¦‚æœé¢„è®¡ 6 ä¸ªæœˆå†…è¾¾åˆ°ä¸Šé™ â†’ å»ºè®®æ‰©å®¹
```

---

## ä¸å…¶ä»– Skills çš„åä½œ

### 1. documentation-enforcer-v2
- è‡ªåŠ¨ä¿å­˜å¥åº·æŠ¥å‘Š
- ç»´æŠ¤æ–‡æ¡£è§„èŒƒ

### 2. systematic-debugging
- æ•°æ®åº“é—®é¢˜è°ƒè¯•
- æ€§èƒ½é—®é¢˜åˆ†æ

### 3. health-checker
- æ•´ä½“ç³»ç»Ÿå¥åº·æ£€æŸ¥
- æ•°æ®åº“æ˜¯å…¶ä¸­ä¸€éƒ¨åˆ†

---

## é…ç½®é€‰é¡¹

**é…ç½®æ–‡ä»¶**: `scripts/database/db-monitor-config.json`

```json
{
  "schedule": {
    "daily": "00:00",
    "weekly": "Monday 00:00",
    "monthly": "1st 00:00"
  },
  "thresholds": {
    "databaseSize": "1GB",
    "recordCount": 10000,
    "queryTime": "1s",
    "diskSpace": "10%"
  },
  "retention": {
    "matchRecords": 30,
    "archiveRecords": 90
  },
  "cleanup": {
    "autoCleanup": true,
    "cleanupAge": 30
  },
  "reporting": {
    "savePath": "docs/05-é—®é¢˜æ’æŸ¥/",
    "format": "markdown"
  }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: æ¯å‘¨è‡ªåŠ¨ç»´æŠ¤

```
å‘¨ä¸€ 00:00 è‡ªåŠ¨è§¦å‘
  â†“
æ‰§è¡Œå¥åº·æ£€æŸ¥
  â”œâ”€ æ•°æ®åº“è¿æ¥: âœ…
  â”œâ”€ æ•°æ®åº“å¤§å°: âš ï¸ 1.2GB
  â”œâ”€ è®°å½•æ•°é‡: âœ… 8,500
  â””â”€ æŸ¥è¯¢æ€§èƒ½: âœ… 250ms
  â†“
æ‰§è¡Œæ¸…ç†æ“ä½œ
  â”œâ”€ åˆ é™¤ 30 å¤©å‰çš„è®°å½•: 1,250 æ¡
  â”œâ”€ æ¸…ç†é‡å¤è®°å½•: 50 æ¡
  â””â”€ æ¸…ç†ç¼“å­˜: 200MB
  â†“
ç”ŸæˆæŠ¥å‘Š
  â†“
ä¿å­˜åˆ° docs/05-é—®é¢˜æ’æŸ¥/æ•°æ®åº“å¥åº·æŠ¥å‘Š-2026-02-15.md
  â†“
é€šçŸ¥ç”¨æˆ·: "æ•°æ®åº“ç»´æŠ¤å®Œæˆï¼Œé‡Šæ”¾ 355MB ç©ºé—´"
```

### ç¤ºä¾‹ 2: æ‰‹åŠ¨è§¦å‘

```
ç”¨æˆ·: "æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€"
  â†“
database-health-monitor æ‰§è¡Œ
  â†“
è¿è¡Œæ‰€æœ‰æ£€æŸ¥è„šæœ¬
  â†“
ç”Ÿæˆå®æ—¶æŠ¥å‘Š
  â†“
é€šçŸ¥ç”¨æˆ·: "æ•°æ®åº“çŠ¶æ€å¥åº·ï¼ŒæŸ¥çœ‹æŠ¥å‘Š"
```

---

**Skill Version**: v1.0
**Created**: 2026-02-15
**Compatibility**: Claude Code 2.0+
